# Fase Base
FROM node:20-alpine AS base
RUN apk add --no-cache g++ make py3-pip libc6-compat
WORKDIR /app
# Instalar pnpm globalmente
RUN npm install -g typescript @nestjs/cli
COPY package.json package-lock.json tsconfig.json ./

# Fase de Construcción
FROM base AS builder
WORKDIR /app
COPY . ./
RUN npm ci

# Declaración de los ARGs (se pasarán desde GitHub Actions)
ARG NODE_ENV=production
ARG PORT=3000
ARG USERS_MICROSERVICE_HOST=0.0.0.0
ARG USERS_SERVICE_PORT=3001
ARG COURSES_SERVICE_HOST=0.0.0.0
ARG COURSES_SERVICE_PORT=3002
ARG UPLOAD_MICROSERVICE_HOST=0.0.0.0
ARG UPLOAD_SERVICE_PORT=3003
ARG JWT_SECRET
ARG FRONTEND_URL

# Variables de entorno
ENV NODE_ENV=$NODE_ENV
ENV PORT=$PORT
ENV USERS_MICROSERVICE_HOST=$USERS_MICROSERVICE_HOST
ENV USERS_SERVICE_PORT=$USERS_SERVICE_PORT
ENV COURSES_SERVICE_HOST=$COURSES_SERVICE_HOST
ENV COURSES_SERVICE_PORT=$COURSES_SERVICE_PORT
ENV UPLOAD_MICROSERVICE_HOST=$UPLOAD_MICROSERVICE_HOST
ENV UPLOAD_SERVICE_PORT=$UPLOAD_SERVICE_PORT
ENV JWT_SECRET=$JWT_SECRET
ENV FRONTEND_URL=$FRONTEND_URL

# Construir el proyecto con pnpm
RUN npm run build

# Fase de Producción
FROM base AS production
WORKDIR /app

# Declaración de los ARGs (se pasarán desde GitHub Actions)
ARG NODE_ENV=production
ARG PORT=3000
ARG USERS_MICROSERVICE_HOST=0.0.0.0
ARG USERS_SERVICE_PORT=3001
ARG COURSES_SERVICE_HOST=0.0.0.0
ARG COURSES_SERVICE_PORT=3002
ARG UPLOAD_MICROSERVICE_HOST=0.0.0.0
ARG UPLOAD_SERVICE_PORT=3003
ARG JWT_SECRET
ARG FRONTEND_URL

# Variables de entorno
ENV NODE_ENV=$NODE_ENV
ENV PORT=$PORT
ENV USERS_MICROSERVICE_HOST=$USERS_MICROSERVICE_HOST
ENV USERS_SERVICE_PORT=$USERS_SERVICE_PORT
ENV COURSES_SERVICE_HOST=$COURSES_SERVICE_HOST
ENV COURSES_SERVICE_PORT=$COURSES_SERVICE_PORT
ENV UPLOAD_MICROSERVICE_HOST=$UPLOAD_MICROSERVICE_HOST
ENV UPLOAD_SERVICE_PORT=$UPLOAD_SERVICE_PORT
ENV JWT_SECRET=$JWT_SECRET
ENV FRONTEND_URL=$FRONTEND_URL

# Configurar usuario seguro para correr la aplicación
RUN addgroup -g 1001 -S nodejs && adduser -S nestjs -u 1001
USER nestjs

# Copiar archivos relevantes de la fase de construcción
COPY --from=builder /app/package.json /app/package-lock.json /app/tsconfig.json ./
COPY --from=builder /app/dist ./dist

EXPOSE $PORT

CMD ["npm", "run", "start:prod"]
